<script>
document.addEventListener("DOMContentLoaded", async () => {
  const content = document.getElementById("content");
  const params = new URLSearchParams(window.location.search);
  const token = params.get("token");
  const payment_id = params.get("payment_id");
  const purchase_id = params.get("purchase_id");

  function showMessage(title, html) {
    content.innerHTML = `<h2>${title}</h2><p class="small">${html}</p>`;
  }

  async function wait(ms) {
    return new Promise((r) => setTimeout(r, ms));
  }

  async function validateAndRender(tokenValue) {
    const v = await fetch(`/.netlify/functions/validateToken?token=${encodeURIComponent(tokenValue)}`);
    const vjson = await v.json();

    if (vjson.success && vjson.file) {
      const expiresAt = new Date(vjson.expires_at);
      const expiryHuman = expiresAt.toLocaleString();

      content.innerHTML = `
        <h2>Thank you for your purchase!</h2>
        <p class="muted">Your download is ready. Click below to access your file.</p>
        <p style="margin-top:18px;">
          <button id="downloadBtn" class="cta">Access your file</button>
        </p>
        <p class="small" style="margin-top:12px;">This link will expire at <strong>${expiryHuman}</strong>.</p>
        <p class="small" style="margin-top:8px;">If you have trouble, contact support at <a href="mailto:support@beparidig.com">support@beparidig.com</a>.</p>
      `;

      document.getElementById("downloadBtn").addEventListener("click", () => {
        const btn = document.getElementById("downloadBtn");
        btn.disabled = true;
        btn.textContent = "Preparing download...";
        window.location.href = vjson.file;
        setTimeout(() => {
          btn.textContent = "Download started";
        }, 2000);
      });
    } else {
      showMessage("Download not ready", "We couldn’t validate your download yet. Please refresh this page in a few seconds.");
    }
  }

  try {
    // ✅ 1. Direct token
    if (token) {
      await validateAndRender(token);
      return;
    }

    // ✅ 2. Payment ID fallback
    if (payment_id) {
      for (let attempt = 0; attempt < 3; attempt++) {
        const res = await fetch(`/.netlify/functions/getTokenByTxn?transaction_id=${encodeURIComponent(payment_id)}`);
        const data = await res.json();

        if (data.token) {
          window.location.href = `/thank-you?token=${data.token}`;
          return;
        }

        await wait(3000); // wait 3s for webhook delay
      }

      showMessage("Verifying your payment…", "Your payment was received, but the download link isn’t ready yet. Please refresh after a few seconds.");
      return;
    }

    // ✅ 3. Purchase/session ID fallback (new)
    if (purchase_id) {
      for (let attempt = 0; attempt < 3; attempt++) {
        const res = await fetch(`/.netlify/functions/getTokenByTxn?transaction_id=${encodeURIComponent(purchase_id)}`);
        const data = await res.json();

        if (data.token) {
          window.location.href = `/thank-you?token=${data.token}`;
          return;
        }

        await wait(3000);
      }

      showMessage("Preparing your download…", "We’re still processing your order. Please refresh in a few seconds.");
      return;
    }

    // ❌ No identifiers
    showMessage(
      "Missing download link",
      'We couldn’t detect your download information. Please check your purchase confirmation or contact <a href="mailto:support@beparidig.com">support@beparidig.com</a>.'
    );
  } catch (err) {
    console.error(err);
    showMessage("Server error", "We couldn’t reach the download service. Please try again later or contact support.");
  }
});
</script>
