<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Thank You ‚Äî BEPARI DIG</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css"/>

  <style>
    .small { color:#666; font-size:0.95rem; }
    .cta {
      background:#007b55;
      color:#fff;
      padding:12px 22px;
      border-radius:6px;
      text-decoration:none;
      display:inline-block;
      border:none;
      cursor:pointer;
      font-size:1rem;
    }
    .cta:disabled {
      background:#999;
      cursor:not-allowed;
    }
    .muted { color:#777; font-size:0.9rem; }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <div class="brand">BEPARI DIG</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="content" style="text-align:center; padding:48px;">
      <h2>Preparing your download‚Ä¶</h2>
      <p class="small" id="sub">Please wait while we prepare your file.</p>
      <div id="spinner" style="margin-top:18px;">‚è≥ Setting up your download‚Ä¶</div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap">
      <p class="small">¬© 2025 BEPARI DIG</p>
    </div>
  </footer>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const content = document.getElementById("content");
  const params = new URLSearchParams(window.location.search);

  const token = params.get("token");
  const payment_id = params.get("payment_id");
  const purchase_id = params.get("purchase_id");

  function showMessage(title, html) {
    content.innerHTML = `<h2>${title}</h2><p class="small">${html}</p>`;
  }

  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  async function renderDownload(tokenValue) {
    const res = await fetch(
      `/.netlify/functions/validateToken?token=${encodeURIComponent(tokenValue)}`
    );

    const data = await res.json();

    if (!data.success) {
      showMessage(
        "Download unavailable",
        "This download link is invalid or has expired. If you believe this is a mistake, please contact <a href='mailto:support@beparidig.com'>support@beparidig.com</a>."
      );
      return;
    }

    const expiry = new Date(data.expires_at).toLocaleString();

    content.innerHTML = `
      <h2>Thank you for your purchase!</h2>
      <p class="muted">Your secure download is ready.</p>

      <p style="margin-top:22px;">
        <button id="downloadBtn" class="cta">Access your file</button>
      </p>

      <p class="small" style="margin-top:14px;">
        This link will expire at <strong>${expiry}</strong>.
      </p>

      <p class="small" style="margin-top:8px;">
        Need help? Contact
        <a href="mailto:support@beparidig.com">support@beparidig.com</a>
      </p>
    `;

    const btn = document.getElementById("downloadBtn");

    btn.addEventListener("click", () => {
      btn.disabled = true;
      btn.textContent = "Preparing download‚Ä¶";

      // üîí Secure download (NO file URL exposed)
      window.location.href =
        `/.netlify/functions/downloadFile?token=${encodeURIComponent(tokenValue)}`;

      setTimeout(() => {
        btn.textContent = "Download started";
      }, 2000);
    });
  }

  try {
    // 1Ô∏è‚É£ Direct token
    if (token) {
      await renderDownload(token);
      return;
    }

    // 2Ô∏è‚É£ Payment ID fallback
    if (payment_id) {
      for (let i = 0; i < 3; i++) {
        const r = await fetch(
          `/.netlify/functions/getTokenByTxn?transaction_id=${encodeURIComponent(payment_id)}`
        );
        const j = await r.json();

        if (j.token) {
          window.location.replace(`/thank-you?token=${j.token}`);
          return;
        }
        await sleep(3000);
      }

      showMessage(
        "Verifying your payment‚Ä¶",
        "Your payment was successful, but the download link is still being prepared. Please refresh this page shortly."
      );
      return;
    }

    // 3Ô∏è‚É£ Purchase/session ID fallback
    if (purchase_id) {
      for (let i = 0; i < 3; i++) {
        const r = await fetch(
          `/.netlify/functions/getTokenByTxn?transaction_id=${encodeURIComponent(purchase_id)}`
        );
        const j = await r.json();

        if (j.token) {
          window.location.replace(`/thank-you?token=${j.token}`);
          return;
        }
        await sleep(3000);
      }

      showMessage(
        "Preparing your download‚Ä¶",
        "Your order is confirmed, but your download isn‚Äôt ready yet. Please refresh this page in a moment."
      );
      return;
    }

    // ‚ùå Nothing usable
    showMessage(
      "Missing download information",
      "We couldn‚Äôt detect your purchase. Please check your confirmation email or contact <a href='mailto:support@beparidig.com'>support@beparidig.com</a>."
    );

  } catch (err) {
    console.error(err);
    showMessage(
      "Server error",
      "We couldn‚Äôt reach the download service. Please try again later or contact support."
    );
  }
});
</script>

</body>
</html>
