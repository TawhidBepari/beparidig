<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Thank You — BEPARI DIG</title>
<link rel="stylesheet" href="style.css">
</head>

<body>
<main class="wrap">
  <section id="content" class="card" style="text-align:center;padding:48px">
    <h2>Preparing your download…</h2>
    <p>Please wait while we verify your purchase.</p>
  </section>
</main>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const content = document.getElementById("content");
  const checkoutId = localStorage.getItem("last_checkout_id");

  if (!checkoutId) {
    content.innerHTML =
      "<h2>Invalid access</h2><p>Please contact support.</p>";
    return;
  }

  const sleep = ms => new Promise(r => setTimeout(r, ms));

  for (let i = 0; i < 8; i++) {
    try {
      const res = await fetch(
        `/.netlify/functions/getTokenByCheckout?checkout_id=${encodeURIComponent(checkoutId)}`,
        { cache: "no-store" }
      );
      const data = await res.json();

      if (data.token) {
        content.innerHTML = `
          <h2>Thank you for your purchase!</h2>
          <p>Your secure download is ready.</p>
          <button id="download">Download file</button>
        `;

        document.getElementById("download").onclick = () => {
          window.location.href =
            "/.netlify/functions/download-file?token=" +
            encodeURIComponent(data.token);
        };
        return;
      }
    } catch {}

    await sleep(3000);
  }

  content.innerHTML =
    "<h2>Almost there…</h2><p>Please refresh this page in a moment.</p>";
});
</script>
</body>
</html>
