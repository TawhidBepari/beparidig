<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Thank You ‚Äî BEPARI DIG</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Source+Sans+3:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css" />

  <style>
    body {
      font-family: "Source Sans 3", sans-serif;
    }
    .small {
      color: #666;
      font-size: 0.95rem;
    }
    .muted {
      color: #777;
      font-size: 0.9rem;
    }
    .cta {
      background: #007b55;
      color: #fff;
      padding: 12px 24px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 1rem;
    }
    .cta:disabled {
      background: #999;
      cursor: not-allowed;
    }
  </style>
</head>

<body>
  <header class="site-header">
    <div class="wrap header-inner">
      <div class="brand">BEPARI DIG</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card" id="content" style="text-align:center; padding:48px;">
      <h2>Preparing your download‚Ä¶</h2>
      <p class="small">Please wait while we verify your purchase.</p>
      <div style="margin-top:18px;">‚è≥</div>
    </section>
  </main>

  <footer class="footer">
    <div class="wrap">
      <p class="small">¬© 2025 BEPARI DIG</p>
    </div>
  </footer>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const content = document.getElementById("content");
  const params = new URLSearchParams(window.location.search);

  // ‚úÖ ONLY ID WE USE
  const checkoutId = params.get("checkout_id");

  function show(title, html) {
    content.innerHTML = `<h2>${title}</h2><p class="small">${html}</p>`;
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function pollForToken() {
    for (let attempt = 1; attempt <= 6; attempt++) {
      try {
        const res = await fetch(
          `/.netlify/functions/getTokenByCheckout?checkout_id=${encodeURIComponent(checkoutId)}`,
          { cache: "no-store" }
        );

        const data = await res.json();

        if (data?.token) {
          renderDownload(data.token);
          return;
        }

      } catch (err) {
        console.error("Polling error:", err);
      }

      await sleep(3000);
    }

    show(
      "Preparing your download‚Ä¶",
      "Your payment was successful. Please refresh this page in a moment if your download doesn‚Äôt appear."
    );
  }

  function renderDownload(token) {
    content.innerHTML = `
      <h2>Thank you for your purchase!</h2>
      <p class="muted">Your secure download is ready.</p>

      <p style="margin-top:22px;">
        <button id="downloadBtn" class="cta">Download your file</button>
      </p>

      <p class="small" style="margin-top:10px;">
        This link can only be used once.
      </p>

      <p class="small" style="margin-top:8px;">
        Need help? <a href="mailto:support@beparidig.com">Contact support</a>
      </p>
    `;

    document.getElementById("downloadBtn").addEventListener("click", () => {
      window.location.href =
        `/.netlify/functions/download-file?token=${encodeURIComponent(token)}`;
    });
  }

  // üö® Hard stop if missing checkout_id
  if (!checkoutId) {
    show(
      "Invalid link",
      "This page was accessed incorrectly. Please check your email or contact <a href='mailto:support@beparidig.com'>support@beparidig.com</a>."
    );
    return;
  }

  // üöÄ Start polling
  pollForToken();
});
</script>

</body>
</html>
