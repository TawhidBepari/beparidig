<!-- Supabase SDK -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  import { SUPABASE_URL, SUPABASE_ANON_KEY } from "./config.js";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Parse URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const productSlug = urlParams.get('product');       // ?product=slug
  const affiliateCode = urlParams.get('affiliate');   // ?affiliate=AFF123

  async function loadProduct() {
    let product;

    if (affiliateCode) {
      const { data: linkData } = await supabase
        .from('affiliate_links')
        .select('product_id')
        .eq('link_code', affiliateCode)
        .single();

      if (!linkData) {
        document.getElementById('product-name').innerText = "Invalid affiliate link";
        return;
      }

      const { data } = await supabase
        .from('products')
        .select('*')
        .eq('id', linkData.product_id)
        .single();
      product = data;

    } else if (productSlug) {
      const { data } = await supabase
        .from('products')
        .select('*')
        .eq('slug', productSlug)
        .single();
      product = data;

    } else {
      document.getElementById('product-name').innerText = "No product specified";
      return;
    }

    if (!product) {
      document.getElementById('product-name').innerText = "Product not found";
      return;
    }

    // Update page
    document.getElementById('product-title').innerText = `${product.name} | BEPARI DIG`;
    document.getElementById('product-meta').setAttribute("content", product.description || "");
    document.getElementById('product-image').src = product.cover_image || "images/cover.png";
    document.getElementById('product-name').innerText = product.name;
    document.getElementById('product-price').innerText = `$${product.price.toFixed(2)}`;
    document.getElementById('product-description').innerText = product.description || "";

    const ul = document.getElementById('product-includes');
    ul.innerHTML = "";
    if (product.includes) {
      product.includes.forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        ul.appendChild(li);
      });
    }

    document.getElementById('buy-now-product').onclick = () => {
      Paddle.Checkout.open({
        items: [{ priceId: product.paddle_price_id, quantity: 1 }],
        passthrough: JSON.stringify({ affiliate: affiliateCode || null })
      });
    };
  }

  loadProduct();
</script>
